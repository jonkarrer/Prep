<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Recipe</title>

    <style>
      input {
        border: none;
        outline: none;
        border-bottom: 1px solid black;
        margin-bottom: 1rem;
      }

      input[name="amount"],
      input[name="unit"],
      input[name="ingredient"] {
        width: 60px;
        margin-right: 1rem;
      }

      .cover {
        position: relative;
      }
      .cover::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;

        height: 115%;
        width: 40px;
        z-index: 2;
        background-color: dimgrey;
        border-radius: 0.6rem;
      }
      .cover::after {
        content: "";
        position: absolute;
        left: 0;
        top: 0;

        height: 115%;
        width: 100%;
        z-index: 1;
        background-color: #fff;
      }

      .General,
      .Ingredients,
      .Directions {
        display: none;
      }

      .show {
        display: block;
      }
    </style>
  </head>
  <body>
    <template id="RecipeIngredient">
      <div>
        <input
          type="text"
          name="ingredient"
          placeholder="ingredient"
          oninput="handleIngredientInput(event)"
        />

        <span onclick="toggleShow(event)" class="cover">
          <input
            type="number"
            name="amount"
            placeholder="amount"
            oninput="handleAmountInput(event)"
          />
          <input
            type="text"
            name="unit"
            placeholder="unit"
            oninput="handleUnitInput(event)"
            onclick="toggleShow(event)"
          />
        </span>
      </div>
    </template>

    <template id="RecipeDirection">
      <input
        type="text"
        name="direction"
        placeholder="direction"
        oninput="handleDirectionInput(event)"
      />
    </template>

    <template id="RecipeTag">
      <input
        type="text"
        name="tag"
        placeholder="tag"
        oninput="handleTagInput(event)"
      />
    </template>

    <main>
      <header>
        <nav>
          <span onclick="showSection('general_section')">General</span>
          <span onclick="showSection('ingredient_section')">Ingredients</span>
          <span onclick="showSection('direction_section')">Directions</span>
        </nav>
      </header>

      <form id="recipe_form" action="/recipe/create" method="POST">
        <section id="general_section" class="General">
          <h2>New Recipe</h2>
          <input type="text" name="title" placeholder="title" />
          <input type="number" name="servings" placeholder="servings" />
          <h4>Tags</h4>
          <recipe-tag></recipe-tag>

          <div onclick="appendNewTagInput(event)">Add</div>
        </section>

        <section id="ingredient_section" class="Ingredients">
          <h3>Ingredients</h3>
          <recipe-ingredient></recipe-ingredient>

          <div onclick="appendNewIngredientInput(event)">Add</div>
        </section>

        <section id="direction_section" class="Directions">
          <h3>Directions</h3>
          <ol>
            <li><recipe-direction></recipe-direction></li>
            <div onclick="appendNewDirectionInput(event)">Add</div>
          </ol>
        </section>

        <button type="submit">Submit</button>
      </form>
    </main>
    <script>
      document
        .getElementById("recipe_form")
        .addEventListener("submit", submitForm);

      async function submitForm(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const path = event.target.action;
        const method = event.target.method;

        const amounts = formData.getAll("amount");
        const units = formData.getAll("unit");
        const ingredients = formData.getAll("ingredient");
        const directions = formData.getAll("direction");
        const tags = formData.getAll("tag");

        let servings = formData.get("servings");
        let recipe = {
          title: formData.get("title"),
          servings: servings ? parseInt(servings) : 0,
          favorite: false,
          ingredients: [],
          directions: [],
          tags: tags,
        };

        for (let i = 0; i < ingredients.length; i++) {
          console.log(parseInt(amounts[i]));
          recipe.ingredients.push({
            name: ingredients[i],
            amount: amounts[i] ? parseInt(amounts[i]) : 0,
            unit: units[i],
          });
        }

        for (let i = 0; i < directions.length; i++) {
          recipe.directions.push({
            step_order: i,
            details: directions[i],
          });
        }

        console.log("recipe", recipe);

        const body = JSON.stringify(recipe);

        let res = await fetch(path, {
          method: method,
          headers: {
            "Content-Type": "application/json",
          },
          //   redirect: "follow",
          body: body,
        });

        console.log("response", await res.json());

        // if (res.redirected) {
        //   window.location = res.url;
        // } else {
        //   let text = await res.text();
        //   handleToast("error", text);
        // }
      }
    </script>

    <script>
      let generalSection = document.getElementById("general_section");
      let ingredientSection = document.getElementById("ingredient_section");
      let directionSection = document.getElementById("direction_section");

      function showGeneralSection() {
        generalSection.classList.add("show");
        ingredientSection.classList.remove("show");
        directionSection.classList.remove("show");
      }

      function showIngredientSection() {
        ingredientSection.classList.add("show");
        generalSection.classList.remove("show");
        directionSection.classList.remove("show");
      }

      function showDirectionSection() {
        directionSection.classList.add("show");
        ingredientSection.classList.remove("show");
        generalSection.classList.remove("show");
      }

      function showSection(section_id) {
        switch (section_id) {
          case "general_section":
            showGeneralSection();
            break;

          case "ingredient_section":
            showIngredientSection();
            break;

          case "direction_section":
            showDirectionSection();
            break;

          default:
            break;
        }
      }
    </script>

    <script>
      function toggleShow(e) {
        e.target.classList.toggle("cover");
      }
      function handleTitleInput(e) {
        console.log("blue", e.target.value);
      }
      function handleServingsInput(e) {
        console.log("blue", e.target.value);
      }

      function handleAmountInput(e) {
        console.log("blue", e.target.value);
      }
      function handleUnitInput(e) {
        console.log("blue", e.target.value);
      }
      function handleIngredientInput(e) {
        console.log("blue", e.target.value);
      }

      function handleDirectionInput(e) {
        console.log("blue", e.target.value);
      }

      function handleTagInput(e) {
        console.log("blue", e.target.value);
      }

      function appendNewIngredientInput(e) {
        const customInputEl = document.createElement("recipe-ingredient");
        e.target.insertAdjacentElement("beforeBegin", customInputEl);
      }

      function appendNewTagInput(e) {
        const customInputEl = document.createElement("recipe-tag");
        e.target.insertAdjacentElement("beforeBegin", customInputEl);
      }

      function appendNewDirectionInput(e) {
        const customInputEl = document.createElement("recipe-direction");
        const listEl = document.createElement("li");
        listEl.appendChild(customInputEl);
        e.target.insertAdjacentElement("beforeBegin", listEl);
      }
    </script>

    <script>
      customElements.define(
        "recipe-tag",
        class extends HTMLElement {
          constructor() {
            super();
            this.template = document.getElementById("RecipeTag").content;
          }
          render() {
            this.appendChild(this.template.cloneNode(true));
          }
          connectedCallback() {
            if (!this.rendered) {
              this.render();
              this.rendered = true;
            }
          }
        }
      );

      customElements.define(
        "recipe-direction",
        class extends HTMLElement {
          constructor() {
            super();
            this.template = document.getElementById("RecipeDirection").content;
          }
          render() {
            this.appendChild(this.template.cloneNode(true));
          }
          connectedCallback() {
            if (!this.rendered) {
              this.render();
              this.rendered = true;
            }
          }
        }
      );

      customElements.define(
        "recipe-ingredient",
        class extends HTMLElement {
          constructor() {
            super();
            this.template = document.getElementById("RecipeIngredient").content;
          }
          render() {
            this.appendChild(this.template.cloneNode(true));
          }
          connectedCallback() {
            if (!this.rendered) {
              this.render();
              this.rendered = true;
            }
          }
        }
      );
    </script>
  </body>
</html>
